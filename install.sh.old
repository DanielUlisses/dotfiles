#!/bin/bash

set -e

function exit_with_message() {
  echo $1
  exit 1
}

#this script is ready for arch based distros
packages_linux=""
packages_additional="lan-mouse-git"

SCRIPT_DIR=$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" &>/dev/null && pwd)

while [ $# -gt 0 ]; do
  case "$1" in
  --install-packages)
    INSTALL=$2
    shift
    ;;
  --install-additional)
    INSTALL_ADDITIONAL=$2
    shift
    ;;
  --setup-ssh)
    SETUP_SSH=$2
    shift
    ;;
  --setup-dotfiles)
    SETUP_DOTFILES=$2
    shift
    ;;
  *)
    echo "Running default options"
    DEFAULT=true
    ;;
  esac
  shift
done

pacman_intall() {
  packages=$1
  sudo pacman -S $packages
}

yay_intall() {
  packages=$1
  yay -S $packages
}

ssh_configure() {
  tar -xzf $HOME/Downloads/ssh-backup.tar.gz -C $HOME
  [[ ! -d $HOME/.ssh ]] && mkdir -p $HOME/.ssh
  mv $HOME/.ssh-backup/* $HOME/.ssh
  chmod 700 $HOME/.ssh
  chmod 600 $HOME/.ssh/*
  chmod 644 $HOME/.ssh/*.pub
}

dotfiles_install() {
  sudo pacman -Syu
  sudo pacman -S stow
  [[ -f $HOME/.config/alacritty/alacritty.yml ]] && mv $HOME/.config/alacritty/alacritty.toml $HOME/.config/alacritty/alacritty.yml.bak
  [[ -f $HOME/.aliases ]] && mv $HOME/.aliases $HOME/.aliases.bak
  [[ -f $HOME/.bashrc ]] && mv $HOME/.bashrc $HOME/.bashrc.bak
  [[ -f $HOME/.config/gh/config.yml ]] && mv $HOME/.config/gh/config.yml $HOME/.config/gh/config.yml.bak
  [[ -f $HOME/.gitconfig ]] && mv $HOME/.gitconfig $HOME/.gitconfig.bak
  [[ -f $HOME/.config/hypr/autostart.conf ]] && mv $HOME/.config/hypr/autostart.conf $HOME/.config/hypr/autostart.conf.bak
  [[ -f $HOME/.config/hypr/bindings.conf ]] && mv $HOME/.config/hypr/bindings.conf $HOME/.config/hypr/bindings.conf.bak
  [[ -f $HOME/.config/hypr/envs.conf ]] && mv $HOME/.config/hypr/envs.conf $HOME/.config/hypr/envs.conf.bak
  [[ -f $HOME/.config/hypr/hypridle.conf ]] && mv $HOME/.config/hypr/hypridle.conf $HOME/.config/hypr/hypridle.conf.bak
  [[ -f $HOME/.config/hypr/hyprland.conf ]] && mv $HOME/.config/hypr/hyprland.conf $HOME/.config/hypr/hyprland.conf.bak
  [[ -f $HOME/.config/hypr/hyprlock.conf ]] && mv $HOME/.config/hypr/hyprlock.conf $HOME/.config/hypr/hyprlock.conf.bak
  [[ -f $HOME/.config/hypr/hyprsunset.conf ]] && mv $HOME/.config/hypr/hyprsunset.conf $HOME/.config/hypr/hyprsunset.conf.bak
  [[ -f $HOME/.config/hypr/input.conf ]] && mv $HOME/.config/hypr/input.conf $HOME/.config/hypr/input.conf.bak
  [[ -f $HOME/.config/hypr/monitors.conf ]] && mv $HOME/.config/hypr/monitors.conf $HOME/.config/hypr/monitors.conf.bak
  [[ -f $HOME/.config/lan-mouse/config.toml ]] && mv $HOME/.config/lan-mouse/config.toml $HOME/.config/lan-mouse/config.toml.bak
  [[ -f $HOME/.config/systemd/user/lan-mouse.service ]] && mv $HOME/.config/systemd/user/lan-mouse.service $HOME/.config/systemd/user/lan-mouse.service.bak
    
  stow -v alacritty
  stow -v bash
  stow -v gh
  stow -v git --dotfiles
  stow -v hypr
  stow -v lan-mouse
}

echo "executing default actions"
dotfiles_install

if [ $INSTALL ]; then
  echo "installing packages " $packages_linux
  pacman_install "$packages_linux"
fi

if [ $INSTALL_ADDITIONAL ]; then
  echo "installing additional packages"
  yay_install "$packages_additional"
fi

if [ $SETUP_DOTFILES ]; then
  echo "setting up dotfiles"
  dotfiles_install
fi

if [ $SETUP_SSH ]; then
  echo "setting up ssh"
  ssh_configure
fi

echo "all steps are completed!!!"
